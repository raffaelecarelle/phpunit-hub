name: CI

on:
    push:
        branches: [ main ]
    pull_request:
        branches: [ main ]

jobs:
    code-quality:
        name: Code Quality
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: 8.2
                    extensions: simplexml, libxml, dom
                    coverage: none

            -   name: Install dependencies
                run: composer install --prefer-dist --no-progress

            -   name: Run PHP CS Fixer
                run: vendor/bin/php-cs-fixer fix --dry-run --diff

            -   name: Run Rector
                run: vendor/bin/rector process --dry-run

            -   name: Run PHPStan
                run: vendor/bin/phpstan analyse

    jest:
        name: Jest (Node ${{ matrix.node }})
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                node: [ '18', '20', '22', '24' ]
        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Setup Node.js
                uses: actions/setup-node@v4
                with:
                    node-version: ${{ matrix.node }}
                    cache: 'npm'

            -   name: Install Node dependencies
                run: npm ci

            -   name: Run Jest tests
                run: npm test -- --ci --reporters=default

    tests:
        name: Tests (PHP ${{ matrix.php }}, PHPUnit ${{ matrix.phpunit-version }})
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                php: [ '8.2', '8.3', '8.4' ]
                phpunit-version: [ '10.5', '11.5', '12.4' ]
                exclude:
                    -   php: '8.4'
                        phpunit-version: '10.5'
                    -   php: '8.2'
                        phpunit-version: '12.4'
        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: ${{ matrix.php }}
                    extensions: simplexml, libxml, dom
                    coverage: none

            -   name: Install dependencies
                run: |
                    composer require "phpunit/phpunit:^${{ matrix.phpunit-version }}" --no-interaction --no-update
                    composer update --prefer-dist --no-progress --with-all-dependencies

            -   name: Run PHPUnit
                run: vendor/bin/phpunit

    release:
        name: Create Release
        runs-on: ubuntu-latest
        if: startsWith(github.ref, 'refs/tags/')
        needs: ["code-quality", "jest", "tests"]
        permissions:
            contents: write
        steps:
            -   name: Create GitHub Release
                uses: softprops/action-gh-release@v2
                with:
                    generate_release_notes: true
