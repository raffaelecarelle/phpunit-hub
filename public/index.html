<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHPUnit Hub</title>
    <link id="favicon" rel="icon" href="#">
    <script>
        window.WS_HOST = '{{ws_host}}';
        window.WS_PORT = '{{ws_port}}';
    </script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="css/styles.css?v={{css_version}}">
    <style>
        [v-cloak] {
            display: none;
        }
        .token-keyword { color: #c586c0; }
        .token-string { color: #ce9178; }
        .token-comment { color: #6a9955; }
        .token-variable { color: #9cdcfe; }
        .token-default { color: #d4d4d4; }
        .line-covered { background-color: rgba(16, 185, 129, 0.1); }
        .line-uncovered { background-color: rgba(248, 113, 113, 0.1); }
    </style>
</head>
<body class="bg-gray-900 text-gray-300 font-sans">
<div id="app" class="flex flex-col h-screen" v-cloak>
    <app-header
        :store="store"
        :app="app"
        :is-any-test-running="isAnyTestRunning"
        :has-failed-tests="hasFailedTests"
        :is-any-stop-pending="isAnyStopPending"
        :results="results"
    ></app-header>

    <!-- Main Container -->
    <div class="flex flex-grow overflow-hidden">
        <test-sidebar
            :store="store"
            :app="app"
            :is-test-running="isTestRunning"
            :is-test-stop-pending="isTestStopPending"
        ></test-sidebar>

        <!-- Resizer -->
        <div id="resizer" class="w-1.5 cursor-col-resize bg-gray-700 hover:bg-blue-600 transition-colors duration-200"></div>

        <main-content
            :store="store"
            :app="app"
            :results="results"
            :grouped-results="groupedResults"
            :individual-results="individualResults"
            :status-counts="statusCounts"
            :is-any-test-running="isAnyTestRunning"
            :format-nanoseconds="formatNanoseconds"
            :get-token-class="getTokenClass"
            :toggle-test-details="toggleTestDetails"
        ></main-content>
    </div>
</div>

<script type="module">
    import { createApp, onMounted, watch, computed } from 'https://cdn.jsdelivr.net/npm/vue@3/dist/vue.esm-browser.prod.js';
    import { App } from './js/app.js';
    import { toggleTestDetails } from './js/utils.js';
    import { Header } from './js/components/Header.js';
    import { TestSidebar } from './js/components/TestSidebar.js';
    import { MainContent } from './js/components/MainContent.js';

    const app = new App();

    const vueApp = createApp({
        setup() {
            const computedVals = app.getComputedValues();

            onMounted(async () => {
                await app.initialize();
                document.addEventListener('click', () => {
                    if (app.store.state.showFilterPanel) {
                        app.store.toggleFilterPanel();
                    }
                });
            });

            // Watch for changes in filters and options, and save them to localStorage
            watch(() => [app.store.state.options, app.store.state.selectedSuites, app.store.state.selectedGroups, app.store.state.coverage], (newState, oldState) => {
                app.store.saveState();
            }, { deep: true });

            return {
                app,
                store: app.store,
                results: computedVals.results,
                groupedResults: computedVals.groupedResults,
                individualResults: computedVals.individualResults,
                statusCounts: computedVals.statusCounts,
                filteredTestSuites: computed(() => computedVals.filteredTestSuites()), // Original line, commented out
                isAnyTestRunning: computedVals.isAnyTestRunning,
                isAnyStopPending: computedVals.isAnyStopPending,
                hasFailedTests: computedVals.hasFailedTests,

                // Methods
                toggleSuite: (suiteId) => app.store.toggleSuiteExpansion(suiteId),
                toggleTestcaseGroup: (className) => app.store.toggleTestcaseGroupExpansion(className),
                toggleTestDetails,
                toggleFilterPanel: () => app.store.toggleFilterPanel(),
                isTestRunning: (runId) => app.store.state.runningTestIds[runId] === true,
                isTestStopPending: (runId) => app.store.state.stopPending[runId] === true,
                formatNanoseconds: (nanoseconds) => {
                    if (nanoseconds === undefined || nanoseconds === null) {
                        return '0.00ms';
                    }
                    const seconds = nanoseconds / 1_000_000_000;
                    if (seconds >= 1) {
                        return `${seconds.toFixed(2)}s`;
                    }
                    return `${(nanoseconds / 1_000_000).toFixed(2)}ms`;
                },
                getTokenClass(tokenType) {
                    if (tokenType.startsWith('T_')) {
                        const t = tokenType.substring(2).toLowerCase();
                        if (['string', 'encapsed_and_whitespace'].includes(t)) return 'string';
                        if (['comment', 'doc_comment'].includes(t)) return 'comment';
                        if (t.includes('variable')) return 'variable';
                        const keywords = ['class', 'function', 'public', 'private', 'protected', 'readonly', 'new', 'echo', 'return', 'if', 'else', 'elseif', 'while', 'do', 'for', 'foreach', 'switch', 'case', 'break', 'continue', 'declare', 'const', 'enddeclare', 'endfor', 'endforeach', 'endif', 'endswitch', 'endwhile', 'use', 'namespace', 'try', 'catch', 'finally', 'throw', 'extends', 'implements', 'interface', 'trait', 'abstract', 'final', 'static', 'instanceof', 'insteadof', 'global', 'goto', 'include', 'include_once', 'require', 'require_once', 'unset', 'isset', 'empty'];
                        if (keywords.includes(t)) return 'keyword';
                    }
                    return 'default';
                }
            };
        }
    });

    vueApp.component('app-header', Header);
    vueApp.component('test-sidebar', TestSidebar);
    vueApp.component('main-content', MainContent);

    vueApp.mount('#app');
</script>
</body>
</html>
